function module(t,e,n){let i,o,s,r,a,c,l,u,d,m,h,g,f,v,p,w,k,C,_,I,y,D;n.link("meteor/rocketchat:tap-i18n",{TAPi18n(t){i=t}},0),n.link("meteor/meteor",{Meteor(t){o=t}},1),n.link("meteor/reactive-var",{ReactiveVar(t){s=t}},2),n.link("meteor/kadira:flow-router",{FlowRouter(t){r=t}},3),n.link("meteor/session",{Session(t){a=t}},4),n.link("meteor/templating",{Template(t){c=t}},5),n.link("underscore",{default(t){l=t}},6),n.link("moment",{default(t){u=t}},7),n.link("ua-parser-js",{default(t){d=t}},8),n.link("../../../../../ui-utils",{modal(t){m=t}},9),n.link("../../../../../models",{Subscriptions(t){h=t}},10),n.link("../../../../../settings",{settings(t){g=t}},11),n.link("../../../../../utils",{t(t){f=t},handleError(t){v=t},roomTypes(t){p=t}},12),n.link("../../../../../authorization",{hasRole(t){w=t},hasPermission(t){k=t},hasAtLeastOnePermission(t){C=t}},13),n.link("./visitorInfo.html"),n.link("../../../../../utils/client",{APIClient(t){_=t}},14),n.link("../../../../../ui-utils/client",{RoomManager(t){I=t}},15),n.link("../../../../../lib/client",{DateFormat(t){y=t}},16),n.link("../customTemplates/register",{getCustomFormTemplate(t){D=t}},17);const R=()=>{const t=c.currentData();if(!t||!t.rid)return!1;const e=h.findOne({rid:t.rid});return void 0!==e},A=t=>!!g.get("Livechat_request_comment_when_closing_conversation")||t&&t.requestTagBeforeClosingChat;c.visitorInfo.helpers({user(){const t=c.instance().user.get();if(t&&t.userAgent){const e=new d;e.setUA(t.userAgent),t.os="".concat(e.getOS().name," ").concat(e.getOS().version),-1!==["Mac OS","iOS"].indexOf(e.getOS().name)?t.osIcon="icon-apple":t.osIcon="icon-".concat(e.getOS().name.toLowerCase()),t.browser="".concat(e.getBrowser().name," ").concat(e.getBrowser().version),t.browserIcon="icon-".concat(e.getBrowser().name.toLowerCase()),t.status=p.getUserStatus("l",this.rid)||"offline"}return t},room:()=>c.instance().room.get(),department:()=>c.instance().department.get(),joinTags(){const t=c.instance().tags.get();return t&&t.join(", ")},customRoomFields(){const t=c.instance().customFields.get();if(!t||0===t.length)return[];const e=[],n=c.instance().room.get(),{livechatData:i={}}=n||{};return Object.keys(i).forEach(n=>{const o=l.findWhere(t,{_id:n});o&&"hidden"!==o.visibility&&"room"===o.scope&&e.push({label:o.label,value:i[n]})}),e},customVisitorFields(){const t=c.instance().customFields.get();if(!C(["view-livechat-room-customfields","edit-livechat-room-customfields"]))return;if(!t||0===t.length)return[];const e=[],n=c.instance().user.get(),{livechatData:i={}}=n||{};return Object.keys(i).forEach(n=>{const o=l.findWhere(t,{_id:n});o&&"hidden"!==o.visibility&&"visitor"===o.scope&&e.push({label:o.label,value:i[n]})}),e},createdAt(){return this.createdAt?u(this.createdAt).format("L LTS"):""},lastLogin(){return this.lastLogin?u(this.lastLogin).format("L LTS"):""},editing:()=>"edit"===c.instance().action.get(),forwarding:()=>"forward"===c.instance().action.get(),sendingTranscript:()=>"transcript"===c.instance().action.get(),roomInfoData(){const t=c.instance(),e=t.user.get();return{visitorId:e?e._id:null,roomId:this.rid,save(){t.action.set()},cancel(){t.action.set()}}},roomOpen(){const t=c.instance().room.get(),e=o.userId();return t&&t.open&&(t.servedBy&&t.servedBy._id===e||w(e,"livechat-manager"))},canReturnQueue(){const t=c.instance().routingConfig.get();return t.returnQueue},showDetail(){if(c.instance().action.get())return"hidden"},canSeeButtons:()=>!!C(["close-others-livechat-room","transfer-livechat-guest"])||R(),canEditRoom:()=>!!k("save-others-livechat-room-info")||R(),canCloseRoom:()=>!!k("close-others-livechat-room")||R(),canForwardGuest:()=>k("transfer-livechat-guest"),canSendTranscript:()=>k("send-omnichannel-chat-transcript"),roomClosedDateTime(){const{closedAt:t}=this;return y.formatDateAndTime(t)},roomClosedBy(){const{closedBy:t={},servedBy:e={}}=this;let{closer:n}=this;if("user"===n){if(e._id!==t._id)return t.username;n="agent"}const i=n.charAt(0).toUpperCase()+n.slice(1);return f("".concat(i))},customInfoTemplate:()=>D("livechatVisitorInfo"),roomDataContext:()=>c.instance().room,transcriptRequest(){const t=c.instance().room.get();return null==t?void 0:t.transcriptRequest},transcriptRequestedDateTime(){const{requestedAt:t}=this;return y.formatDateAndTime(t)}}),c.visitorInfo.events({"click .edit-livechat"(t,e){t.preventDefault(),e.action.set("edit")},"click .close-livechat"(t,e){if(t.preventDefault(),!A(e.department.get())){const t=i.__("Chat_closed_by_agent");return o.call("livechat:closeRoom",this.rid,t,{clientAction:!0},(function(t){if(t)return v(t);m.open({title:f("Chat_closed"),text:f("Chat_closed_successfully"),type:"success",timer:1e3,showConfirmButton:!1})}))}m.open({title:f("Closing_chat"),modifier:"modal",content:"closeRoom",data:{rid:this.rid},confirmOnEnter:!1,showConfirmButton:!1,showCancelButton:!1})},"click .return-inquiry"(t){t.preventDefault(),m.open({title:f("Would_you_like_to_return_the_inquiry"),type:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:f("Yes")},()=>{o.call("livechat:returnAsInquiry",this.rid,(function(t){t?v(t):(a.set("openedRoom"),r.go("/home"))}))})},"click .forward-livechat"(t,e){t.preventDefault(),e.action.set("forward")},"click .send-transcript"(t,e){t.preventDefault(),e.action.set("transcript")}}),c.visitorInfo.onCreated((function(){this.visitorId=new s(null),this.customFields=new s([]),this.action=new s,this.user=new s,this.departmentId=new s(null),this.tags=new s(null),this.routingConfig=new s({}),this.department=new s({}),this.room=new s({}),this.updateVisitor=async t=>{const{visitor:e}=await _.v1.get("livechat/visitors.info?visitorId=".concat(t));this.user.set(e)},this.updateRoom=t=>{this.departmentId.set(t&&t.departmentId),this.tags.set(t&&t.tags),this.room.set(t);const e=t&&t.v&&t.v._id;this.visitorId.set(e),this.updateVisitor(e)},o.call("livechat:getCustomFields",(t,e)=>{e&&this.customFields.set(e)});const{rid:t}=c.currentData();o.call("livechat:getRoutingConfig",(t,e)=>{e&&this.routingConfig.set(e)});const e=async t=>{const{room:e}=await _.v1.get("rooms.info?roomId=".concat(t));this.updateRoom(e)};t&&(I.roomStream.on(t,this.updateRoom),e(t)),this.autorun(async()=>{if(this.departmentId.get()){const{department:t}=await _.v1.get("livechat/department/".concat(this.departmentId.get(),"?includeAgents=false"));this.department.set(t)}}),this.autorun(()=>{const t=this.visitorId.get();t&&this.updateVisitor(t)})})),c.visitorInfo.onDestroyed((function(){const{rid:t}=c.currentData();I.roomStream.removeListener(t,this.updateRoom)}))}

